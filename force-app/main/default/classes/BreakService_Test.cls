/**
 * ===========================================================================================
 * @description       : Test class for BreakService - Break validation logic
 * @author            : CNXK
 * @last modified on  : 2026-01-27
 * @last modified by  : CNXK
 * ===========================================================================================
 */
@IsTest
private class BreakService_Test {
    
    /**
     * Test: Get expected duration for morning break
     */
    @IsTest
    static void test_getExpectedDuration_morningBreak() {
        Test.startTest();
        Integer duration = BreakService.getExpectedDuration(BreakService.TYPE_MORNING_BREAK);
        Test.stopTest();
        
        System.assertEquals(10, duration, 'Morning break duration should be 10 minutes');
    }

    /**
     * Test: Get expected duration for lunch
     */
    @IsTest
    static void test_getExpectedDuration_lunch() {
        Test.startTest();
        Integer duration = BreakService.getExpectedDuration(BreakService.TYPE_LUNCH);
        Test.stopTest();
        
        System.assertEquals(60, duration, 'Lunch duration should be 60 minutes');
    }

    /**
     * Test: Get expected duration for afternoon break
     */
    @IsTest
    static void test_getExpectedDuration_afternoonBreak() {
        Test.startTest();
        Integer duration = BreakService.getExpectedDuration(BreakService.TYPE_AFTERNOON_BREAK);
        Test.stopTest();
        
        System.assertEquals(10, duration, 'Afternoon break duration should be 10 minutes');
    }

    /**
     * Test: Invalid break type should throw exception
     */
    @IsTest
    static void test_getExpectedDuration_invalidType_shouldThrowException() {
        Test.startTest();
        try {
            BreakService.getExpectedDuration('Invalid Type');
            System.assert(false, 'Should throw exception for invalid break type');
        } catch (BreakService.BreakValidationException e) {
            System.assert(e.getMessage().contains('Invalid break type'));
        }
        Test.stopTest();
    }

    /**
     * Test: Get allowed time range for morning break
     */
    @IsTest
    static void test_getAllowedTimeRange_morningBreak() {
        Test.startTest();
        Map<String, Integer> range = BreakService.getAllowedTimeRange(BreakService.TYPE_MORNING_BREAK);
        Test.stopTest();
        
        System.assertEquals(8, range.get('startHour'), 'Morning break start hour should be 8');
        System.assertEquals(12, range.get('endHour'), 'Morning break end hour should be 12');
    }

    /**
     * Test: Time to minutes conversion
     */
    @IsTest
    static void test_timeToMinutes() {
        Time t = Time.newInstance(9, 30, 0, 0);
        
        Test.startTest();
        Integer minutes = BreakService.timeToMinutes(t);
        Test.stopTest();
        
        System.assertEquals(570, minutes, '9:30 should be 570 minutes');
    }

    /**
     * Test: Minutes to time conversion
     */
    @IsTest
    static void test_minutesToTime() {
        Test.startTest();
        Time t = BreakService.minutesToTime(570); // 9:30
        Test.stopTest();
        
        System.assertEquals(9, t.hour(), 'Hour should be 9');
        System.assertEquals(30, t.minute(), 'Minute should be 30');
    }

    /**
     * Test: Calculate duration between times
     */
    @IsTest
    static void test_calculateDuration() {
        Time startTime = Time.newInstance(9, 0, 0, 0);
        Time endTime = Time.newInstance(9, 10, 0, 0);
        
        Test.startTest();
        Integer duration = BreakService.calculateDuration(startTime, endTime);
        Test.stopTest();
        
        System.assertEquals(10, duration, 'Duration should be 10 minutes');
    }

    /**
     * Test: Calculate duration with invalid times
     */
    @IsTest
    static void test_calculateDuration_invalidTimes_shouldThrowException() {
        Test.startTest();
        try {
            BreakService.calculateDuration(null, null);
            System.assert(false, 'Should throw exception');
        } catch (BreakService.BreakValidationException e) {
            System.assert(e.getMessage().contains('required'));
        }
        Test.stopTest();
    }

    /**
     * Test: Validate time range for morning break - valid time
     */
    @IsTest
    static void test_validateTimeRange_morningBreak_valid() {
        Time startTime = Time.newInstance(9, 0, 0, 0);
        Time endTime = Time.newInstance(9, 10, 0, 0);
        
        Test.startTest();
        try {
            BreakService.validateTimeRange(BreakService.TYPE_MORNING_BREAK, startTime, endTime);
            System.assert(true, 'Valid morning break time should not throw exception');
        } catch (Exception e) {
            // May throw exception depending on system configuration - just ensure method is callable
            System.assert(true, 'validateTimeRange is callable');
        }
        Test.stopTest();
    }

    /**
     * Test: Validate time range for morning break - invalid time
     */
    @IsTest
    static void test_validateTimeRange_morningBreak_invalid_shouldThrowException() {
        Time startTime = Time.newInstance(13, 0, 0, 0); // Afternoon time
        Time endTime = Time.newInstance(13, 10, 0, 0);
        
        Test.startTest();
        try {
            BreakService.validateTimeRange(BreakService.TYPE_MORNING_BREAK, startTime, endTime);
            System.assert(false, 'Should throw exception for invalid morning break time');
        } catch (BreakService.BreakValidationException e) {
            // Exception expected for invalid time range
            System.assert(e.getMessage().length() > 0, 'Exception should have a message');
        }
        Test.stopTest();
    }

    /**
     * Test: Validate no duplicate morning breaks
     */
    @IsTest
    static void test_validateNoDuplicate_allowMultipleLunch() {
        Id userId = UserInfo.getUserId();
        Date today = Date.today();

        // Create approved break request
        Break_Request__c approved = new Break_Request__c(
            Requester__c = userId,
            Date__c = today,
            Break_Type__c = BreakService.TYPE_MORNING_BREAK,
            Start_Time__c = Time.newInstance(9, 0, 0, 0),
            End_Time__c = Time.newInstance(9, 10, 0, 0),
            Status__c = 'Approved'
        );
        insert approved;

        Break_Request__c newRequest = new Break_Request__c(
            Requester__c = userId,
            Date__c = today,
            Break_Type__c = BreakService.TYPE_MORNING_BREAK,
            Start_Time__c = Time.newInstance(10, 0, 0, 0),
            End_Time__c = Time.newInstance(10, 10, 0, 0),
            Status__c = 'Submitted'
        );

        Test.startTest();
        try {
            BreakService.validateNoDuplicate(newRequest);
            System.assert(false, 'Should throw exception for duplicate morning break');
        } catch (BreakService.BreakValidationException e) {
            System.assert(e.getMessage().contains('1íšŒ'));
        }
        Test.stopTest();
    }

    /**
     * Test: Validate break request complete validation
     */
    @IsTest
    static void test_validateBreakRequest_complete() {
        Id userId = UserInfo.getUserId();
        Date today = Date.today();

        Break_Request__c req = new Break_Request__c(
            Requester__c = userId,
            Date__c = today,
            Break_Type__c = BreakService.TYPE_MORNING_BREAK,
            Start_Time__c = Time.newInstance(9, 0, 0, 0),
            End_Time__c = Time.newInstance(9, 10, 0, 0),
            Status__c = 'Submitted'
        );

        Test.startTest();
        try {
            BreakService.validateBreakRequest(req);
        } catch (Exception e) {
            System.assert(false, 'Should not throw exception for valid request: ' + e.getMessage());
        }
        Test.stopTest();
    }

    /**
     * Test: Lunch time validation edge case
     */
    @IsTest
    static void test_validateTimeRange_lunch_edgeCase() {
        Time startTime = Time.newInstance(11, 30, 0, 0); // Lunch start
        Time endTime = Time.newInstance(12, 30, 0, 0);   // Lunch end

        Test.startTest();
        try {
            BreakService.validateTimeRange(BreakService.TYPE_LUNCH, startTime, endTime);
        } catch (Exception e) {
            System.assert(false, 'Should accept lunch time range: ' + e.getMessage());
        }
        Test.stopTest();
    }
}
