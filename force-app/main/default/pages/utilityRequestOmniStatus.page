<apex:page showHeader="false" sidebar="false">
    <apex:includeLightning />
    <!-- ğŸ”‘ í•„ìˆ˜: Omni Channel Console Integration JS -->
    <apex:includeScript value="/support/console/60.0/integration.js"/>
    <style>
        /* ì „ì²´ í˜ì´ì§€ ìµœì†Œí™” - LWCëŠ” ë¡œë“œí•˜ë˜ í™”ë©´ì€ ìµœì†Œí™” */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: transparent;
        }
        
        /* Visualforce Page í—¤ë”/ë¼ë²¨ ìˆ¨ê¸°ê¸° */
        .slds-page-header,
        .slds-page-header__title,
        .slds-page-header__name,
        h1, h2, .pageTitle, .bPageTitle {
            display: none !important;
        }
        
        /* Lightning ì»´í¬ë„ŒíŠ¸ ì»¨í…Œì´ë„ˆ */
        #lightningvf {
            height: 100%;
            width: 100%;
            overflow: hidden;
            display: block;
        }
        
        /* LWC ì»´í¬ë„ŒíŠ¸ê°€ ì „ì²´ ë†’ì´ë¥¼ ì‚¬ìš©í•˜ë„ë¡ */
        c-utility-request {
            display: block;
            height: 100%;
            width: 100%;
        }
        
        /* LWC ë‚´ë¶€ ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ ì œê±° ë° ë†’ì´ ì¡°ì ˆ */
        c-utility-request .container {
            height: 100%;
            overflow-y: visible !important;
            overflow-x: hidden;
        }
    </style>
    <div id="lightningvf"></div>
    <script>
        var eventListenerAttached = false;
        var statusChangeQueue = []; // ìƒíƒœ ë³€ê²½ ìš”ì²­ í
        var isProcessingStatusChange = false; // í˜„ì¬ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬ ì¤‘ì¸ì§€
        var lastStatusChangeTime = 0; // ë§ˆì§€ë§‰ ìƒíƒœ ë³€ê²½ ì‹œê°„
        var STATUS_CHANGE_DEBOUNCE_MS = 500; // ë””ë°”ìš´ìŠ¤ ì‹œê°„ (500ms)
        
        // ğŸ”‘ í•µì‹¬: ì˜´ë‹ˆì±„ë„ ìƒíƒœ ë³€ê²½ í•¨ìˆ˜ (í ê¸°ë°˜ ìˆœì°¨ ì²˜ë¦¬)
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œí•˜ì—¬ LWCì—ì„œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡
        window.setServicePresenceStatus = function(statusId) {
            console.log('[VF] window.setServicePresenceStatus called with statusId:', statusId, 'from caller:', arguments.callee.caller);
            setServicePresenceStatusInternal(statusId);
        };
        
        // window.parentì™€ window.topì—ë„ ë…¸ì¶œ (ë‹¤ë¥¸ iframeì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡)
        try {
            if (window.parent && window.parent !== window) {
                window.parent.setServicePresenceStatus = window.setServicePresenceStatus;
                console.log('[VF] Exposed setServicePresenceStatus to window.parent');
            }
        } catch (e) {
            console.warn('[VF] Failed to expose setServicePresenceStatus to window.parent:', e);
        }
        
        try {
            if (window.top && window.top !== window && window.top !== window.parent) {
                window.top.setServicePresenceStatus = window.setServicePresenceStatus;
                console.log('[VF] Exposed setServicePresenceStatus to window.top');
            }
        } catch (e) {
            console.warn('[VF] Failed to expose setServicePresenceStatus to window.top:', e);
        }
        
        function setServicePresenceStatusInternal(statusId) {
            console.log('[VF] setServicePresenceStatusInternal called with statusId:', statusId);
            
            // ë””ë°”ìš´ì‹±: ë„ˆë¬´ ë¹ ë¥¸ ì—°ì† í˜¸ì¶œ ë°©ì§€
            var now = Date.now();
            if (now - lastStatusChangeTime < STATUS_CHANGE_DEBOUNCE_MS) {
                console.log('Debouncing status change request...');
                setTimeout(function() {
                    setServicePresenceStatus(statusId);
                }, STATUS_CHANGE_DEBOUNCE_MS - (now - lastStatusChangeTime));
                return;
            }
            
            // íì— ë™ì¼í•œ ìƒíƒœ IDê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ì œê±°)
            var existingIndex = -1;
            for (var i = 0; i < statusChangeQueue.length; i++) {
                if (statusChangeQueue[i].statusId === statusId) {
                    existingIndex = i;
                    break;
                }
            }
            
            if (existingIndex >= 0) {
                // ë™ì¼í•œ ìƒíƒœ IDê°€ íì— ìˆìœ¼ë©´ ê¸°ì¡´ í•­ëª©ì„ ì œê±°í•˜ê³  ìƒˆë¡œ ì¶”ê°€ (ìµœì‹  ìš”ì²­ ìš°ì„ )
                console.log('Removing duplicate status change request from queue:', statusId);
                statusChangeQueue.splice(existingIndex, 1);
            }
            
            // íì— ì¶”ê°€
            statusChangeQueue.push({
                statusId: statusId,
                timestamp: now,
                retryCount: 0
            });
            
            // í ì²˜ë¦¬ ì‹œì‘
            processStatusChangeQueue();
        }
        
        // ìƒíƒœ ë³€ê²½ í ì²˜ë¦¬ (ìˆœì°¨ì ìœ¼ë¡œ í•˜ë‚˜ì”©)
        function processStatusChangeQueue() {
            // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ ëŒ€ê¸°
            if (isProcessingStatusChange) {
                return;
            }
            
            // íê°€ ë¹„ì–´ìˆìœ¼ë©´ ì¢…ë£Œ
            if (statusChangeQueue.length === 0) {
                return;
            }
            
            // ì²˜ë¦¬ ì¤‘ í”Œë˜ê·¸ ì„¤ì •
            isProcessingStatusChange = true;
            
            // íì—ì„œ ì²« ë²ˆì§¸ ìš”ì²­ ê°€ì ¸ì˜¤ê¸°
            var request = statusChangeQueue.shift();
            var statusId = request.statusId;
            var maxRetries = 3;
            
            console.log('Processing status change:', statusId, '(Queue length: ' + statusChangeQueue.length + ')');
            
            if (typeof sforce !== 'undefined' && sforce.console && sforce.console.presence) {
                // íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ)
                var timeoutId = setTimeout(function() {
                    console.error('Status change API call timeout after 10 seconds:', statusId);
                    isProcessingStatusChange = false;
                    // íƒ€ì„ì•„ì›ƒ ì‹œ ì¬ì‹œë„
                    if (request.retryCount < maxRetries) {
                        request.retryCount++;
                        console.warn('Status change timeout, retrying... (attempt ' + (request.retryCount + 1) + '/' + maxRetries + ')');
                        statusChangeQueue.unshift(request);
                        setTimeout(function() {
                            processStatusChangeQueue();
                        }, 500);
                    } else {
                        console.error('Status change failed after ' + maxRetries + ' retries (timeout):', statusId);
                        setTimeout(function() {
                            processStatusChangeQueue();
                        }, 100);
                    }
                }, 10000);
                
                try {
                    sforce.console.presence.setServicePresenceStatus(statusId, 
                        function(result) { 
                            clearTimeout(timeoutId); // íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
                            console.log('Status changed response:', result);
                            
                            // ì‘ë‹µ ê²€ì¦: successê°€ trueì´ê³  statusIdê°€ ìˆëŠ”ì§€ í™•ì¸
                            var isSuccess = false;
                            if (result) {
                                // resultê°€ ê°ì²´ì´ê³  successê°€ trueì¸ ê²½ìš°
                                if (result.success === true || result.success === 'true') {
                                    isSuccess = true;
                                    lastStatusChangeTime = Date.now();
                                    console.log('Status changed successfully:', statusId, result);
                                } else if (result === true) {
                                    // result ìì²´ê°€ trueì¸ ê²½ìš° (ì¼ë¶€ API ë²„ì „)
                                    isSuccess = true;
                                    lastStatusChangeTime = Date.now();
                                    console.log('Status changed successfully (boolean true):', statusId);
                                }
                            }
                            
                            // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
                            if (!isSuccess && request.retryCount < maxRetries) {
                                request.retryCount++;
                                console.warn('Status change failed, retrying... (attempt ' + (request.retryCount + 1) + '/' + maxRetries + ')', result);
                                // í ì•ì— ë‹¤ì‹œ ì¶”ê°€ (ìš°ì„  ì²˜ë¦¬)
                                statusChangeQueue.unshift(request);
                                // 500ms í›„ ì¬ì‹œë„
                                setTimeout(function() {
                                    isProcessingStatusChange = false;
                                    processStatusChangeQueue();
                                }, 500);
                            } else {
                                // ì„±ê³µ ë˜ëŠ” ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼
                                if (!isSuccess) {
                                    console.error('Status change failed after ' + maxRetries + ' retries:', statusId, result);
                                }
                                // ì²˜ë¦¬ ì™„ë£Œ
                                isProcessingStatusChange = false;
                                // ë‹¤ìŒ ìš”ì²­ ì²˜ë¦¬
                                setTimeout(function() {
                                    processStatusChangeQueue();
                                }, 100);
                            }
                        }
                    );
                } catch (error) {
                    clearTimeout(timeoutId);
                    console.error('Error calling setServicePresenceStatus:', error);
                    // ì—ëŸ¬ ë°œìƒ ì‹œ ì¬ì‹œë„
                    if (request.retryCount < maxRetries) {
                        request.retryCount++;
                        console.warn('Status change error, retrying... (attempt ' + (request.retryCount + 1) + '/' + maxRetries + ')');
                        statusChangeQueue.unshift(request);
                        setTimeout(function() {
                            isProcessingStatusChange = false;
                            processStatusChangeQueue();
                        }, 500);
                    } else {
                        console.error('Status change failed after ' + maxRetries + ' retries (error):', statusId);
                        isProcessingStatusChange = false;
                        setTimeout(function() {
                            processStatusChangeQueue();
                        }, 100);
                    }
                }
            } else {
                console.error('sforce.console.presence API not available');
                // APIê°€ ì—†ìœ¼ë©´ ì¬ì‹œë„í•˜ì§€ ì•Šê³  íì—ì„œ ì œê±°
                isProcessingStatusChange = false;
                // ë‹¤ìŒ ìš”ì²­ ì²˜ë¦¬
                setTimeout(function() {
                    processStatusChangeQueue();
                }, 100);
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œí•˜ì—¬ LWCì—ì„œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡
        window.logout = function() {
            console.log('[VF] window.logout called', 'from caller:', arguments.callee.caller);
            logoutInternal();
        };
        
        // window.parentì™€ window.topì—ë„ ë…¸ì¶œ (ë‹¤ë¥¸ iframeì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡)
        try {
            if (window.parent && window.parent !== window) {
                window.parent.logout = window.logout;
                console.log('[VF] Exposed logout to window.parent');
            }
        } catch (e) {
            console.warn('[VF] Failed to expose logout to window.parent:', e);
        }
        
        try {
            if (window.top && window.top !== window && window.top !== window.parent) {
                window.top.logout = window.logout;
                console.log('[VF] Exposed logout to window.top');
            }
        } catch (e) {
            console.warn('[VF] Failed to expose logout to window.top:', e);
        }
        
        function logoutInternal() {
            console.log('[VF] logoutInternal called');
            if (typeof sforce !== 'undefined' && sforce.console && sforce.console.presence) {
                sforce.console.presence.logout(function(result) { 
                    console.log('Logged out:', result);
                    lastStatusChangeTime = Date.now();
                });
            } else {
                console.error('[VF] sforce.console.presence API not available for logout');
            }
        }
        
        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ (ì „ì—­ìœ¼ë¡œ ì •ì˜í•˜ì—¬ ì¬ì‚¬ìš©)
        function handleStatusEvent(event) {
            console.log('[VF] selectedstatus event received:', event.detail);
            if(event.detail && event.detail.statusId) {
                // ì˜´ë‹ˆì±„ë„ ìƒíƒœ ë³€ê²½
                setServicePresenceStatus(event.detail.statusId);
            } else if(event.detail && event.detail.cmd === 'logout') {
                // ë¡œê·¸ì•„ì›ƒ
                logout();
            }
        }
        
        // postMessage í•¸ë“¤ëŸ¬ (iframe ê°„ í†µì‹ ìš©)
        function handlePostMessage(event) {
            console.log('[VF] postMessage received:', event.data, 'from origin:', event.origin);
            
            if (event.data && event.data.type === 'selectedstatus') {
                if (event.data.detail && event.data.detail.statusId) {
                    console.log('[VF] selectedstatus postMessage received:', event.data.detail);
                    setServicePresenceStatus(event.data.detail.statusId);
                } else if (event.data.detail && event.data.detail.cmd === 'logout') {
                    console.log('[VF] logout postMessage received');
                    logoutInternal();
                }
            }
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜ (ì‹¤ì œ ì‘ë™í•˜ëŠ” ì½”ë“œì™€ ë™ì¼í•œ ë°©ì‹)
        function attachEventListener() {
            if (eventListenerAttached) {
                console.log('[VF] Event listener already attached');
                return true;
            }
            
            var lwcComponent = document.querySelector('c-utility-request');
            var attached = false;
            
            if (lwcComponent) {
                // ì‹¤ì œ ì‘ë™í•˜ëŠ” ì½”ë“œì™€ ë™ì¼: LWC ì»´í¬ë„ŒíŠ¸ì— ì§ì ‘ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                lwcComponent.addEventListener('selectedstatus', handleStatusEvent);
                attached = true;
                console.log('[VF] Event listener attached to utilityRequest component');
            }
            
            // document ë ˆë²¨ì—ë„ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ì´ë²¤íŠ¸ê°€ bubbles upë  ìˆ˜ ìˆë„ë¡)
            document.addEventListener('selectedstatus', handleStatusEvent);
            attached = true;
            console.log('[VF] Event listener attached to document');
            
            // window ë ˆë²¨ì—ë„ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            if (window.addEventListener) {
                window.addEventListener('selectedstatus', handleStatusEvent);
                attached = true;
                console.log('[VF] Event listener attached to window');
            }
            
            // postMessage ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (iframe ê°„ í†µì‹ ìš©)
            window.addEventListener('message', handlePostMessage);
            attached = true;
            console.log('[VF] postMessage listener attached');
            
            if (attached) {
                eventListenerAttached = true;
                return true;
            } else {
                console.warn('[VF] utilityRequest component not found, will retry...');
                return false;
            }
        }
        
        console.log('[VF] Visualforce page loaded');
        
        // LWC ì»´í¬ë„ŒíŠ¸ ë¡œë“œ
        $Lightning.use("c:utilityRequestOmniStatus", function() {
            $Lightning.createComponent("c:utilityRequest", {}, "lightningvf", 
                function(cmp) {
                    console.log('[VF] LWC component created');
                    
                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì‹œë„ (ìµœëŒ€ 10ë²ˆ, 500ms ê°„ê²©)
                    // ì‹¤ì œ ì‘ë™í•˜ëŠ” ì½”ë“œëŠ” ê°„ë‹¨í•œ ì¬ì‹œë„ ë¡œì§ ì‚¬ìš©
                    var retryCount = 0;
                    var maxRetries = 10;
                    
                    function tryAttachListener() {
                        if (attachEventListener()) {
                            console.log('[VF] Event listener attached successfully');
                        } else {
                            retryCount++;
                            if (retryCount < maxRetries) {
                                console.log('[VF] Retrying to attach event listener, attempt ' + (retryCount + 1) + '/' + maxRetries);
                                setTimeout(tryAttachListener, 500);
                            } else {
                                console.error('[VF] Failed to attach event listener after ' + maxRetries + ' attempts');
                            }
                        }
                    }
                    
                    // ì²« ì‹œë„ëŠ” 500ms í›„ (ì‹¤ì œ ì‘ë™í•˜ëŠ” ì½”ë“œì™€ ìœ ì‚¬í•œ íƒ€ì´ë°)
                    setTimeout(tryAttachListener, 500);
                });
        });
    </script>
</apex:page>
